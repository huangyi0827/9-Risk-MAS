# Risk-MAS 框架图说明

## 整体流程

```
输入 → 1.状态模块 → 2.输入规范化 → 3.数据与指标模块 → 4.编排模块 → 5/6.并行分析 → 7.汇总与决策 → 输出
```

---

## 模块详细说明

### 1. 状态模块
```
┌─────────────────┐
│   state.py      │
│  (显式State定义) │
└─────────────────┘
```

### 2. 输入规范化模块
```
┌─────────────────┐
│  validate.py    │
│ (校验与归一化)    │
└─────────────────┘
```

### 3. 数据与指标模块
```
┌─────────────────┬─────────────────┬─────────────────┐
│  csv_data.py    │ data_quality.py │  snapshot.py    │
│   (数据读取)     │  (数据质量检查)   │   (指标快照)      │
└─────────────────┴─────────────────┴─────────────────┘
                          │
                          ▼
               ┌─────────────────────┐
               │      utils.py       │  
               │ (共享工具函数)        │
               │ normalize_weights   │
               │ compute_hhi         │
               │ compute_effective_n │
               └─────────────────────┘
```

### 4. 编排模块
```
┌─────────────────────────────────────────────────────┐
│                    graph.py                         │
│              (流程编排与并行调度)                      │
└─────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────┐       │
│ gatekeeper.py   │───────┤
│ (裁剪候选节点)    │       │
└─────────────────┘       │
                          │  
                          ▼
                  ┌─────────────────┐
                  │ supervisor.py   │
                  │ (LLM调度决策)    │
                  └─────────────────┘
                           │
                           │ Send API (并行分发)
                           ▼
```

### 5. 分析链路模块 + 6. Agent模块（并行执行）
```
                    ┌─────────────────────────────────────────┐
                    │           并行执行区域                    │
                    │  ┌─────────────┐  ┌─────────────┐       │
                    │  │ market.py   │  │concentration│       │
          ┌─────────┼─→│  (市场风险)  │  │   .py       │←──────┼─┐
          │         │  └─────────────┘  │  (集中度)    │       │ │
          │         │                   └─────────────┘       │ │
supervisor├─────────┼─→┌─────────────┐  ┌─────────────┐←──────┼─┤
          │         │  │diversific-  │  │liquidity.py │       │ │
          │         │  │  ation.py   │  │  (流动性)    │       │ │
          │         │  │  (分散度)    │  └─────────────┘       │ │
          │         │  └─────────────┘                        │ │
          │         │                                         │ │
          │         │  ┌─────────────┐  ┌─────────────┐       │ │
          └─────────┼─→│macro_agent  │  │compliance_  │←──────┼─┘
                    │  │    .py      │  │  agent.py   │       │
                    │  │ 宏观Agent    │  │  合规Agent  │       │
                    │  └─────────────┘  └─────────────┘       │
                    │                                         │
                    └─────────────────────────────────────────┘
                                      │
                                      │ 全部汇聚
                                      ▼
```

### 7. 汇总与决策模块
```
┌─────────────────┐
│   reducer.py    │
│ (风险汇总输出)    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐     ┌─────────────────┐
│  decision.py    │────→│   solver.py     │ (restrict时触发)
│   (决策引擎)     │     │  (约束求解)       │
└────────┬────────┘     └─────────────────┘
         │
         ├── pass ──→ 放行
         ├── warn ──→ 预警
         ├── restrict → 限制 + 调仓建议
         └── block ──→ 阻断
         │
         ▼
┌─────────────────┐
│    audit.py     │
│  (审计与追溯)     │
└─────────────────┘
         │
         ▼
       完成
```

---

## Skills 模块
```
┌─────────────────────────────────────────────────────┐
│                   skills_runtime.py                 │
│              (读取SKILL/Schema/工具白名单)            │
└─────────────────────────────────────────────────────┘
         │
         ▼
┌────────────────────────────────────────────────────────────────┐
│  skills/                                                       │
│  ├── macro-tool-calling/                                       │
│  │   ├── SKILL.md              (技能定义)                       │
│  │   └── output.schema.json    (输出结构)                       │
│  ├── compliance-tool-calling/                                  │
│  │   ├── SKILL.md                                              │
│  │   └── output.schema.json                                    │
│  ├── snippets/                                                 │
│  │   ├── evidence_rules.md     (证据规范)                       │
│  │   └── decision_rubric.md    (决策标准)                       │
│  └── tools/                                                    │
│      └── tool_interfaces.yaml  (工具注册表)                      │
└────────────────────────────────────────────────────────────────┘
```

---

## 配置模块（新增）
```
┌─────────────────┐
│   config.py     │ 
│  (集中配置管理)   │
│                 │
│ MARKET_LOOKBACK │
│ MACRO_STALE_DAYS│
│ MACRO_SEVERITY_ │
│   WEIGHT        │
│ CASH_SYMBOL     │
│ LP_TURNOVER_    │
│   WEIGHT        │
│ PORTFOLIO_AUM   │
│ LLM_MODEL       │
│ LLM_TEMPERATURE │
└─────────────────┘
```

---

## Tools 模块汇总
```
┌──────────────────────────────────────────────────────────────┐
│                            tools/                            │
├──────────────────────────────────────────────────────────────┤
│ utils.py                 共享工具函数（新增）                    │
│ validate.py              输入校验与归一化                       │
│ csv_data.py              CSV数据读取                          │
│ data_quality.py          数据质量检查                          │
│ snapshot.py              指标快照计算                          │
│ constraints.py           规则评估与硬约束                       │
│ decision.py              决策引擎                             │
│ solver.py                约束求解（cvxpy）                     │
│ rules.py                 规则加载                             │
│ audit.py                 审计输出                             │
│ calibrate_rules.py       规则阈值校准                          │
│ calibrate_macro_series.py 宏观序列阈值校准                      │
└──────────────────────────────────────────────────────────────┘
```

---
